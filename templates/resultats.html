<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse compl√®te</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef1f5;
            padding: 40px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h2, h3 { color: #333; }
        .card {
            background: #f8f9fc;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4a90e2;
        }
        .badge {
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
        }
        .pos { background: #2ecc71; }
        .neg { background: #e74c3c; }
        .neu { background: #95a5a6; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table th, table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .back {
            text-align: center;
            margin-top: 20px;
        }
        .back a {
            background: #4a90e2;
            padding: 10px 12px;
            color: white;
            border-radius: 8px;
            text-decoration: none;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .stats-box {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        .stat-item h4 {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
        }
    </style>
</head>

<body>
<div class="container">

    <h2>Avis analys√©</h2>
    <div class="card">
        <p>{{ avis }}</p>
    </div>

    <!-- STATISTIQUES GLOBALES -->
    <h3>üìä Statistiques Globales</h3>
    <div class="stats-box">
        <div class="stat-item">
            <h4>Sentiment Global</h4>
            <p class="badge {% if document.score > 0.2 %}pos{% elif document.score < -0.2 %}neg{% else %}neu{% endif %}">
                {{ document.label }}
            </p>
        </div>
        <div class="stat-item">
            <h4>Score</h4>
            <p>{{ "%.3f"|format(document.score) }}</p>
        </div>
        <div class="stat-item">
            <h4>Coh√©rence</h4>
            <p>{{ "%.1f"|format(document.coherence * 100) }}%</p>
        </div>
        {% if summary %}
        <div class="stat-item">
            <h4>√âmotion Dominante</h4>
            <p style="font-size: 18px;">{{ summary.dominant_emotion|capitalize }}</p>
        </div>
        {% endif %}
    </div>

    <!-- COMPARAISON DES M√âTHODES -->
    <h3>üîç Comparaison des M√©thodes d'Analyse</h3>
    <div class="card">
        <div class="chart-container">
            <canvas id="methodsChart"></canvas>
        </div>
        <p style="text-align: center; color: #666; font-size: 14px;">
            TextBlob: {{ "%.3f"|format(document.tb_score) }} | 
            VADER: {{ "%.3f"|format(document.vader_score) }} | 
            Coh√©rence: {{ "%.1f"|format(document.coherence * 100) }}%
        </p>
    </div>

    <!-- NIVEAU PHRASES AVEC GRAPHIQUE -->
    <h3>üìù Analyse par Phrase</h3>
    <div class="grid-2">
        <div class="card">
            <h4>Distribution des Sentiments</h4>
            <div class="chart-container">
                <canvas id="phrasesChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h4>D√©tail des Phrases</h4>
            <table>
                <tr><th>Phrase</th><th>Score</th><th>Sentiment</th></tr>
                {% for p in phrases %}
                <tr>
                    <td>{{ p.phrase[:50] }}{% if p.phrase|length > 50 %}...{% endif %}</td>
                    <td>{{ "%.3f"|format(p.score) }}</td>
                    <td>
                        <span class="badge {% if p.score > 0.2 %}pos{% elif p.score < -0.2 %}neg{% else %}neu{% endif %}" style="font-size: 12px;">
                            {{ p.label }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <!-- CONTRADICTIONS -->
    {% if contradictions and contradictions|length > 0 %}
    <h3>‚ö†Ô∏è Phrases Contradictoires D√©tect√©es</h3>
    <div class="card" style="border-left-color: #f39c12;">
        <p><strong>{{ contradictions|length }}</strong> phrases avec sentiments oppos√©s d√©tect√©es :</p>
        <table>
            <tr><th>Phrase</th><th>Score</th></tr>
            {% for c in contradictions %}
            <tr>
                <td>{{ c.phrase }}</td>
                <td>{{ "%.3f"|format(c.score) }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <!-- HEATMAP ASPECTS -->
    <h3>üéØ Heatmap Sentiments par Aspect</h3>
    <div class="card">
        <div class="chart-container" style="height: 350px;">
            <canvas id="aspectsHeatmap"></canvas>
        </div>
        {% if summary %}
        <div style="display: flex; justify-content: space-around; margin-top: 15px;">
            <div style="text-align: center;">
                <strong style="color: #2ecc71;">‚úì Meilleur Aspect</strong>
                <p>{{ summary.best_aspect|capitalize if summary.best_aspect else 'N/A' }}</p>
            </div>
            <div style="text-align: center;">
                <strong style="color: #e74c3c;">‚úó Aspect √† Am√©liorer</strong>
                <p>{{ summary.worst_aspect|capitalize if summary.worst_aspect else 'N/A' }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- EMOTIONS AVEC GRAPHIQUES -->
    <h3>üòä Analyse √âmotionnelle</h3>
    <div class="grid-2">
        <div class="card">
            <h4>Distribution des √âmotions (Barres)</h4>
            <div class="chart-container">
                <canvas id="emotionChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h4>R√©partition √âmotionnelle (Camembert)</h4>
            <div class="chart-container">
                <canvas id="emotionPieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- SCRIPTS GRAPHIQUES -->
    <script>
        // Donn√©es
        const emotions = {{ emotions|tojson }};
        const phrases = {{ phrases|tojson }};
        const aspects = {{ aspects|tojson }};
        const document = {{ document|tojson }};

        // Configuration commune
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        };

        // 1. Graphique Comparaison des M√©thodes
        new Chart(document.getElementById("methodsChart"), {
            type: "bar",
            data: {
                labels: ["TextBlob", "VADER", "Score Final"],
                datasets: [{
                    label: "Score",
                    data: [document.tb_score, document.vader_score, document.score],
                    backgroundColor: ["#3498db", "#9b59b6", "#2ecc71"],
                    borderRadius: 5
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: { 
                        beginAtZero: true,
                        min: -1,
                        max: 1
                    }
                }
            }
        });

        // 2. Graphique Distribution des Phrases
        const phrasesData = phrases.map(p => p.score);
        const phrasesLabels = phrases.map((p, i) => `P${i + 1}`);
        const phrasesColors = phrasesData.map(s => 
            s > 0.2 ? '#2ecc71' : s < -0.2 ? '#e74c3c' : '#95a5a6'
        );

        new Chart(document.getElementById("phrasesChart"), {
            type: "bar",
            data: {
                labels: phrasesLabels,
                datasets: [{
                    label: "Sentiment",
                    data: phrasesData,
                    backgroundColor: phrasesColors,
                    borderRadius: 5
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: { 
                        beginAtZero: true,
                        min: -1,
                        max: 1
                    }
                }
            }
        });

        // 3. Heatmap Aspects (simulations avec barres horizontales)
        const aspectsKeys = Object.keys(aspects);
        const aspectsValues = Object.values(aspects).map(v => v === null ? 0 : v);
        const aspectsColors = aspectsValues.map(v => 
            v > 0.2 ? '#2ecc71' : v < -0.2 ? '#e74c3c' : '#95a5a6'
        );

        new Chart(document.getElementById("aspectsHeatmap"), {
            type: "bar",
            data: {
                labels: aspectsKeys.map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                datasets: [{
                    label: "Score Sentiment",
                    data: aspectsValues,
                    backgroundColor: aspectsColors,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        min: -1,
                        max: 1
                    }
                }
            }
        });

        // 4. √âmotions - Barres
        const emotionsFiltered = Object.entries(emotions)
            .filter(([k, v]) => v > 0)
            .sort((a, b) => b[1] - a[1]);
        
        new Chart(document.getElementById("emotionChart"), {
            type: "bar",
            data: {
                labels: emotionsFiltered.map(e => e[0].charAt(0).toUpperCase() + e[0].slice(1)),
                datasets: [{
                    label: "Intensit√©",
                    data: emotionsFiltered.map(e => e[1]),
                    backgroundColor: ["#3498db", "#e74c3c", "#f39c12", "#9b59b6", "#1abc9c", "#34495e"],
                    borderRadius: 5
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: { 
                        beginAtZero: true,
                        max: 1
                    }
                }
            }
        });

        // 5. √âmotions - Camembert
        if (emotionsFiltered.length > 0) {
            new Chart(document.getElementById("emotionPieChart"), {
                type: "doughnut",
                data: {
                    labels: emotionsFiltered.map(e => e[0].charAt(0).toUpperCase() + e[0].slice(1)),
                    datasets: [{
                        data: emotionsFiltered.map(e => e[1]),
                        backgroundColor: ["#3498db", "#e74c3c", "#f39c12", "#9b59b6", "#1abc9c", "#34495e"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>

    <!-- LIEN -->
    <div class="back">
        <a href="/">‚Üê Nouvelle analyse</a>
    </div>

</div>
</body>
</html>


